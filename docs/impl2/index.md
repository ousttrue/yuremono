# 実装案2(Rotate Particle)

Unity で実装中。

https://github.com/ousttrue/yuremono/tree/master/unity/Assets/RotateParticle

布の縦糸の質点に親子関係をもたせることで、ローカル回転を追加する構想。

```
[T, R] => 質点シミューレーション => [T'] => [R, T'] から [R'] を決定する => [T', R']
```

## 紐のR' 回転確定

- [x] parent の回転から回転を元に戻した場合の位置を得る(rest)。current を rest 方向に引っぱるばねを作る

  - Stiffness と 紐長さの兼用になっているので分離する。紐は伸びないように強くする。

- ~~質点のシミュレーションの結果に対して、親から再帰的にFromTo rotate で回転を確定する(SpringBoneの始祖と同じ)~~ 再帰にせずに個別に実装した。

- [x] 紐の流さ制約は、普通のばね実装にする(Clothの縦拘束)。
- [x] 回転と移動の両方を更新する。

## 布のR' 回転確定

- 回転の決定方法は紐と同じでもいいかもしれない。

- 初期姿勢で質点のローカル回転を計算する。
  - Z: 点法線
  - Y: 親の質点への方向ベクトル
- 上記ローカル回転と bone のワールド回転の相対回転を計算(InitRotation)

- 質点のシミュレーションの結果からローカル回転を計算する。
  - Z: 点法線
  - Y: 親の質点への方向ベクトル
- ローカル回転とInitRotation を乗算する。

## 検証

- 厳しいコリジョンでの振動の発生具合
- TimeDelta と Force 単位の正しい扱い
- Unity.Jobs 実装(最後の結果書き戻し以外は再帰が必要ないはず)
